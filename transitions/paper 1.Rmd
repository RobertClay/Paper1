---
title: "Paper 1 notebook"
output: html_notebook
---


```{r}
source("utils.R")
source("notebook_utils.R")# load in utility functions
require(lme4)
require(tidyr)
# for presentation.
require(ggfortify)
require(Hmisc)
# for missingness.
require(tidyr)
require(VIM)
require(mice)
require(lattice) # for histogram.
require(laeken) # for weighedMean.
# for extrapolation.
require(tidyr)
require(glmnet)
# for heterogeneity.
require(tidyr)
require(glmnet)
require(geepack)
require(lme4)
require(MuMIn)
library(jtools) # for forest plots
library(ggstance) # needed for jtools but not a dependency ..
library(sandwich)
library(sjPlot)

```


#########################################################################
## Baseline 
```{r}
# Preprocessing data.


data <- format_baseline_data("/Users/robertclay/paper1/data/corrected_US/", c(2011,2012))
summary(data)
# Rescale continuous variables
scaled_variables <- c("age", "gross_hh_income", "SF.12")
data[,scaled_variables] <- scale(data[,scaled_variables])

# Convert discrete variables to factors. 
data$depression_change <- factor(data$depression_change, ordered=T)

data <- tidyr::drop_na(data)
n <- nrow(data)
set.seed(88)
Inx <- sample(n, 0.8*n)
train<-data[Inx,]
test<-data[-Inx,]

y <- train$depression
y2<- test$depression
```

```{r}
data <- format_transition_data(c(2011,2012, 2013), "SF.12")
data$ethnicity <- relevel(factor(data$ethnicity), ref="WBI")
data$education_state <- relevel(factor(data$education_state), ref="GCSE")
data$region <- relevel(factor(data$region), ref="London")

sf12.lm <- lm(y ~ factor(sex) + 
               factor(ethnicity) + 
               age + 
               factor(education_state) + 
               factor(labour_state) + 
               factor(job_sec) +
               factor(region) +
               gross_hh_income, 
               data= data)
a<- summary(sf12.lm)
print(a)
print(a$adj.r.squared)

pdf("../plots/ols_residuals.pdf")
hist(scale(a$residuals), xlab="Residuals", ylab = "Density", breaks = 100)
dev.off()

#pdf("../plots/ols_forest_plot.pdf")
#plot_summs(sf12.lm)
#dev.off()

pdf("../plots/ols_forest_plot.pdf")
plot_models(sf12.lm, p.shape=T)
dev.off()
```

Baseline data analysis for SF.12
```{r}
sf12.lm <- lm(SF.12 ~ factor(sex) + 
               factor(ethnicity) + 
               age + 
               factor(education_state) + 
               factor(labour_state) + 
               factor(job_sec) +
               factor(region) +
               gross_hh_income, 
               data= train)

preds <- predict(sf12.lm, test)

a<- summary(sf12.lm)
print(a)
print(a$adj.r.squared)
pdf("../plots/SF12_residuals.pdf")
plot(residuals(sf12.lm))
dev.off()
```


## Presentation

assess assumptions of linear model for SF.12.
see 4 plots
Residuals vs Fitted. Used to check the linear relationship assumptions. A horizontal line, without distinct patterns is an indication for a linear relationship, what is good.

Normal Q-Q. Used to examine whether the residuals are normally distributed. It’s good if residuals points follow the straight dashed line.

Scale-Location (or Spread-Location). Used to check the homogeneity of variance of the residuals (homoscedasticity). Horizontal line with equally spread points is a good indication of homoscedasticity. This is not the case in our example, where we have a heteroscedasticity problem.

Residuals vs Leverage. Used to identify influential cases, that is extreme values that might influence the regression results when included or excluded from the analysis. 

```{r}
pdf("../plots/first_sf12_dist.pdf")
hist(train$SF.12)
dev.off()

pdf("../plots/SF12_residuals.pdf")
hist(residuals(sf12.lm))
dev.off()

pdf("../plots/SF12_diagnostics.pdf")
autoplot(sf12.lm)
dev.off()
```

see residuals and leverage stable aparat from extreme outliers.
qq plot does okay but deviates on left tail. suggests over estimating more depressed individual SF12 scores. scale location clearly non constant. suggests heteroscedasticity which would be expected in data with repeat observations like this. 

There are obvious highly extreme values here. See major leverage values for observations with index 92349 and 71315 (PID 884636487 and 681114527). In this case it is due to individuals suddenly experiencing over 10x increases in income. Their SF12 score is majorly over estimated. 

Removing from the data..

```{r}
train2 <- train[(which(train$pidp %nin% c(884636487, 681114527, 750749251, 68397127, 1361073051, 1088667767))),]
sf12.lm2<-lm(SF.12 ~ factor(sex) + 
                    factor(ethnicity) + 
                    age + 
                    factor(education_state) + 
                     factor(labour_state) + 
                     factor(job_sec) +
                      gross_hh_income, 
                       data= train2)
print(summary(sf12.lm2))

pdf("../plots/no_outliers_sf12_residuals.pdf")
hist(residuals(sf12.lm2))
dev.off()

pdf("../plots/no_outliers_diagnostics.pdf")
autoplot(sf12.lm2)
dev.off()
```

# Missingness


Structure of missingness.
clear vast majority of missing are in depression states.
rest of states have low enough percentages to impute via MI. 
35922 entries total. 

```{r}
pdf("../plots/total_missingness_structure.pdf")
aggr(data, numbers=T, cex.axis=0.5, col = c(blue, orange))
dev.off()

pdf("../plots/depression_missingness_structure.pdf")
aggr(data[, c("SF.12", "depression", "depression_change")], labels = c("SF.12", "depression", "depression_change"), cex.axis = 0.7, oma=c(8,8,4,4), combined=F, sortVars=T, varheight=F, numbers=T, prop=T, col = c(blue, orange))
dev.off()

```

see groupings of missingness by various levels.
```{r}
pdf("../plots/ethnicity_SF12_spinogram.pdf")
spineMiss(data[, c("ethnicity", "SF.12")], col = c(blue, orange))
dev.off()

pdf("../plots/age_SF12_spinogram.pdf")
spineMiss(data[, c("age", "SF.12")], col = c(blue, orange))
dev.off()

pdf("../plots/jbsec_SF12_spinogram.pdf")
spineMiss(data[, c("job_sec", "SF.12")], col = c(blue, orange))
dev.off()

pdf("../plots/labour_SF12_spinogram.pdf")
spineMiss(data[, c("labour_state", "SF.12")], col = c(blue, orange))
dev.off()
```

see same for continuous variables
```{r}
is_missing_sf12 <- is.na(data$SF.12)
is_missing_dep <- is.na(data$depression)
is_missing_depc <- is.na(data$depression_change)

pdf("../plots/age_SF12_histograms.pdf")
histogram(~age|is_missing_sf12, data)
dev.off()
pdf("../plots/age_HLPRB_histograms.pdf")
histogram(~age|is_missing_dep, data)
dev.off()

pdf("../plots/age_GHQ_histograms.pdf")
histogram(~age|is_missing_depc, data)
dev.off()

# do this for household too?
```


MICE
```{r}
data$depression <- as.factor(data$depression)
data$depression_change <- as.factor(data$depression_change)
imp_columns <- c("SF.12", "depression_change","depression", "labour_state",
                 "age", "sex", "ethnicity", "job_sec", "education_state")
print(summary(data[,c("SF.12", "depression_change", "depression")]))
mice_set <- mice(data = data[,imp_columns],
                 m = 2, maxit = 5, seed = 500,
                 remove.collinear=T)
print(summary(complete(mice_set[,c("SF.12", "depression_change", "depression")])))
```


SF.12 pooled regression
```{r}
mice.sf12.lm <- with(mice_set, lm(SF.12 ~ factor(sex) + 
               factor(ethnicity) + 
               data$age + 
               factor(education_state) + 
               factor(labour_state) + 
               factor(job_sec)))
final.pool<- with(data=mice_set, expr={lm(SF.12~depression+depression_change)})

summary(final)
mice.preds<- predict(mice.sf12.lm, test)

pdf("../plots/SF12_MICE_comparison_histogram.pdf")
hist(data$SF.12, col = t_blue, border = blue, freq=F, ylim = c(0, 0.05))
hist(mice.preds, col = t_orange, border = orange, freq=F, add = T)
legend("topright", c("Complete", "Imputed"), fill=c(blue, orange))
dev.off()


pdf("..plots/MICE_depression_scatter.pdf")
plot_depression_residuals(mice.preds, test$SF.12)
dev.off()
```












# Extrapolation

```{r}
data <- format_baseline_data("/Users/robertclay/paper1/data/corrected_US/", c(2008, 2009, 2010))
summary(data)
data <- tidyr::drop_na(data)
n <- nrow(data)
set.seed(8)
Inx <- sample(n, 0.8*n)
train<-data[Inx,]
test<-data[-Inx,]
sf12.lm <- lm(SF.12 ~ factor(sex) + 
               factor(ethnicity) + 
               age + 
               factor(education_state) + 
               factor(labour_state) + 
               factor(job_sec), 
               data= train)

preds <- predict(sf12.lm, test)

a<- summary(sf12.lm)
print(a)
print(a$adj.r.squared)
plot(residuals(sf12.lm))

qqnorm(predict(sf12.lm, test))
qqline(test$SF.12)
```

```{r}
data <- format_baseline_data("/Users/robertclay/paper1/data/corrected_US/", c(2008,2009,2010))
summary(data)
# Rescale continuous variables
scaled_variables <- c("age", "gross_hh_income", "SF.12")
data[,scaled_variables] <- scale(data[,scaled_variables])

# Convert discrete variables to factors. 
data$depression_change <- factor(data$depression_change, ordered=T)

data <- tidyr::drop_na(data)
n <- nrow(data)
set.seed(88)
Inx <- sample(n, 0.8*n)
train<-data[Inx,]
test<-data[-Inx,]

y <- train$depression
y2<- test$depression

sf12.lm <- lm(SF.12 ~ factor(sex) + 
               factor(ethnicity) + 
               age + 
               factor(education_state) + 
               factor(labour_state) + 
               factor(job_sec) +
               factor(region) +
               gross_hh_income, 
               data= train)

preds <- predict(sf12.lm, test)

a<- summary(sf12.lm)
print(a)
print(a$adj.r.squared)
pdf("../plots/0810_SF12_residuals.pdf")
plot(residuals(sf12.lm))
dev.off()
```

```{r}
data <- format_baseline_data("/Users/robertclay/paper1/data/corrected_US/", c(2013,2014,2015))
summary(data)
# Rescale continuous variables
scaled_variables <- c("age", "gross_hh_income", "SF.12")
data[,scaled_variables] <- scale(data[,scaled_variables])

# Convert discrete variables to factors. 
data$depression_change <- factor(data$depression_change, ordered=T)

data <- tidyr::drop_na(data)
n <- nrow(data)
set.seed(88)
Inx <- sample(n, 0.8*n)
train<-data[Inx,]
test<-data[-Inx,]

y <- train$depression
y2<- test$depression

sf12.lm <- lm(SF.12 ~ factor(sex) + 
               factor(ethnicity) + 
               age + 
               factor(education_state) + 
               factor(labour_state) + 
               factor(job_sec) +
               factor(region) +
               gross_hh_income, 
               data= train)

preds <- predict(sf12.lm, test)

a<- summary(sf12.lm)
print(a)
print(a$adj.r.squared)
pdf("../plots/1315_SF12_residuals.pdf")
plot(residuals(sf12.lm))
dev.off()
```

LASSO now

```{r}
# Preprocessing data.


data <- format_baseline_data("/Users/robertclay/paper1/data/corrected_US/", c(2011,2012,2013))
summary(data)
# Rescale continuous variables
scaled_variables <- c("age", "gross_hh_income")
data[,scaled_variables] <- scale(data[,scaled_variables])

# Convert discrete variables to factors. 
data$depression_change <- factor(data$depression_change, ordered=T)
data <- tidyr::drop_na(data)
n <- nrow(data)
set.seed(88)
Inx <- sample(n, 0.8*n)
train <-data[Inx,]
train <- train[order(train$pidp, train$time),]
test <-data[-Inx,]
test <- test[order(train$pidp, train$time),]

y <- train$depression
y2<- test$depression

x <- model.matrix(SF.12 ~ (factor(sex) + 
               factor(ethnicity) + 
               age + 
               factor(education_state) + 
               factor(labour_state) + 
               factor(job_sec) +
               factor(region) +
               gross_hh_income),
               data=data)
x2<- x[-Inx,]
x<- x[Inx,]
y <- data[Inx, "SF.12"]
y2 <- data[-Inx, "SF.12"]

# Fit LASSO
lasso <- glmnet(x, y, alpha = 1, family = "gaussian")
cv.lasso <- cv.glmnet(x, y, alpha = 1, family = "gaussian")


# Plot LASSO
plot(lasso, xvar = "lambda", label = T) 
abline(v = log(cv.lasso$lambda.min), col = "blue",lty=2)
abline(v = log(cv.lasso$lambda.1se), col = "red")
#text(-7.34, 1.6, "Minimum error", col="blue")
#text(-4.75, 1.6, "1 standard error", col="red")

plot(cv.lasso)
coef(cv.lasso, s = "lambda.min")

best.min<- glmnet(x2, y2, alpha=1, family = "gaussian", lambda = cv.lasso$lambda.min)
best.1se<- glmnet(x2, y2, alpha=0.5, family = "gaussian", lambda = cv.lasso$lambda.1se)

# note the type = "class" is preferable here. 
# the choice of a cutoff at p=0.5 is very arbitrary and this function helps
# to optimise the position of that line.
# For the the bubble plot is best for visual interpretation.
```

# Heterogeneity

```{r}
 leveneTest(y~factor(time), data=data)

```
```{r}
dep.gee <- geeglm(SF.12 ~ factor(sex) + 
               factor(ethnicity) + 
               age + 
               factor(education_state) + 
               factor(labour_state) + 
               factor(job_sec) + 
               gross_hh_income + 1:pidp , data = train, family = gaussian,id=pidp
              , corstr="ar1")

print(summary(dep.gee))
print(QIC(dep.gee))

```

```{r}
dep.glmm <- lmer(SF.12  ~  factor(sex) + 
               factor(ethnicity) + 
               age + 
               factor(education_state) + 
               factor(labour_state) + 
               factor(job_sec) + 
               gross_hh_income +  
                (1|pidp), data = train)


glmm.sum <- summary(dep.glmm)
AIC(dep.glmm)
r.squaredGLMM(dep.glmm)



```

```{r}
with(mice_set, lmer(SF.12  ~  factor(sex) + 
               factor(ethnicity) + 
               age + 
               factor(education_state) + 
               factor(labour_state) + 
               factor(job_sec) + 
               gross_hh_income +  
                (1|pidp)))
```